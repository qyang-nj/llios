# Swift Source Info (`.swiftsourceinfo`)
The `.swiftsourceinfo` file is generated by the Swift compiler during compilation. It's enabled by default if `-emit-module` is present. The file records the Swift source information of a Swift module, including source file properties and symbols (USR) declarations.

## Usage
Because `.swiftsourceinfo` is an implementation detail to the compiler, there is almost no documentation for how the file is used. I only found [this proposal](https://forums.swift.org/t/proposal-emitting-source-information-file-during-compilation/28794) when it's added.

As far as I can tell, **swift source info is used by SourceKit for indexing**, at least for some code patterns. For example, the code blow has a synthesized symbol (`s:10FooLibrary0A8ProtocolPA2A0A6StructVRszrlE3fooSSvpZ::SYNTHESIZED::s:10FooLibrary0A6StructV`). If we use `foo` in a different module, jumping to definition doesn't work without `.swiftsourceinfo`, even with a fully populated IndexStore.

```swift
// xcrun swiftc -emit-module -module-name FooModule -emit-symbol-graph -emit-symbol-graph-dir . FooLibrary.swift
// FooLibrary.swift
public protocol FooProtocol {}
public struct FooStruct : FooProtocol {}

extension FooProtocol where Self == FooStruct {
  public static var foo: String {
    "Hello, world!"
  }
}

// In another module
print(FooStruct.foo)
```

However, `.swiftsourceinfo` [always embeds the absolute paths](https://github.com/apple/swift/blob/c2ca810126074406f03dc29a44f4ad4b12f04c79/lib/Serialization/SerializeDoc.cpp#L760-L762). If the file is downloaded from a remote cache, the local indexing is also hindered. Therefore we need a tool to remap the source paths.

The `.swiftsourceinfo` file cloud also be used by the debugger (lldb), but I haven't found a case to confirm that.

## File Format
> [!WARNING]
> The format of `.swiftsourceinfo` is not guaranteed to be stable. It may change across different compiler versions. The following content is verified with Swift 5.9.

Like everything else in LLVM and Swift, `.swiftsourceinfo` file is in a [LLVM Bitstream](https://llvm.org/docs/BitCodeFormat.html#bitstream-format) binary format. Using `llvm-bcanalyzer`, we can see the high level block structure of a `.swiftsourceinfo`.

```
$ llvm-bcanalyzer -dump FooLibrary.swiftmodule/Project/arm64-apple-ios-simulator.swiftsourceinfo
<BLOCKINFO_BLOCK/>
<MODULE_SOURCEINFO_BLOCK NumWords=367 BlockCodeSize=2>
  <CONTROL_BLOCK NumWords=41 BlockCodeSize=3>
    <METADATA abbrevid=5 op0=3 op1=0 op2=0 op3=0 op4=0 op5=0 op6=0 op7=0/> blob data = 'Apple Swift version 5.9.2 (swiftlang-5.9.2.2.56 clang-1500.1.0.2.5)'
    <MODULE_NAME abbrevid=4/> blob data = 'FooLibrary'
    <TARGET abbrevid=6/> blob data = 'arm64-apple-ios17.2-simulator'
  </CONTROL_BLOCK>
  <DECL_LOCS_BLOCK NumWords=321 BlockCodeSize=4>
    <SOURCE_FILE_LIST abbrevid=4/> blob data = unprintable, 168 bytes.
    <BASIC_DECL_LOCS abbrevid=5/> blob data = unprintable, 552 bytes.
    <DECL_USRS abbrevid=6 op0=324/> blob data = unprintable, 396 bytes.
    <TEXT_DATA abbrevid=7/> blob data = unprintable, 117 bytes.
    <DOC_RANGES abbrevid=8/> blob data = unprintable, 1 bytes.
  </DECL_LOCS_BLOCK>
</MODULE_SOURCEINFO_BLOCK>
```

However, if we want to understand what information are there and how they are stored, we need to look into the Swift source code. The serializing logic starts at [here](https://github.com/apple/swift/blob/279e147ae2ddeaf609b45a089b7acd77a00c5049/lib/Frontend/Serialization.cpp#L174) and The deserializing logic starts at [here](https://github.com/apple/swift/blob/c2ca810126074406f03dc29a44f4ad4b12f04c79/lib/Serialization/SerializedModuleLoader.cpp#L302).


### MODULE_SOURCEINFO_BLOCK
`MODULE_SOURCEINFO_BLOCK` is the only core block that a `.swiftsourceinfo` file has. It contains two sub blocks, `CONTROL_BLOCK` and `DECL_LOCS_BLOCK`.

* [Serializing MODULE_SOURCEINFO_BLOCK](https://github.com/apple/swift/blob/c2ca810126074406f03dc29a44f4ad4b12f04c79/lib/Serialization/SerializeDoc.cpp#L880-L909)
* [Parsing MODULE_SOURCEINFO_BLOCK](https://github.com/apple/swift/blob/c2ca810126074406f03dc29a44f4ad4b12f04c79/lib/Serialization/ModuleFileSharedCore.cpp#L1232-L1299)

#### CONTROL_BLOCK
`CONTROL_BLOCK` has three records for the basic compilation information: the module name (e.g. FooLibrary), the compiler version (e.g. Apple Swift version 5.9.2), and the target triple (e.g. arm64-apple-ios17.2-simulator).

* [Serializing CONTROL_BLOCK](https://github.com/apple/swift/blob/c2ca810126074406f03dc29a44f4ad4b12f04c79/lib/Serialization/SerializeDoc.cpp#L856-L877)

#### DECL_LOCS_BLOCK
`DECL_LOCS_BLOCK` is much more interesting than `CONTROL_BLOCK` and has all the source information. It consists of five records, which are described below.
* [Parsing DECL_LOCS_BLOCK](https://github.com/apple/swift/blob/c2ca810126074406f03dc29a44f4ad4b12f04c79/lib/Serialization/ModuleFileSharedCore.cpp#L1169-L1230)

##### SOURCE_FILE_LIST
`SOURCE_FILE_LIST` contains a list of fixed-size item, with each containing source file information.
```c
struct SourceFileRecord {
  uint32_t FileID;          // the offset to TEXT_DATA, indicating the file path
  uint8_t Fingerprint1[32]; // hash of interface including type members
  uint8_t Fingerprint2[32]; // hash of interface excluding type members
  uint64_t Timestamp;
  uint64_t FileSize;
};
```
* [Serializing SOURCE_FILE_LIST](https://github.com/apple/swift/blob/c2ca810126074406f03dc29a44f4ad4b12f04c79/lib/Serialization/SerializeDoc.cpp#L752)
* [Parsing SOURCE_FILE_LIST](https://github.com/apple/swift/blob/c2ca810126074406f03dc29a44f4ad4b12f04c79/lib/Serialization/ModuleFile.cpp#L1089-L1141)

##### BASIC_DECL_LOCS
`BASIC_DECL_LOCS` consists of a list of fixed-size item, with each representing a location of a USR declaration.
```c
// The layout of one record item
struct DeclLocRecord {
  uint32_t FileID;         // the offset to TEXT_DATA, indicating the file path
  uint32_t DocRangeID;      // the offset to DocRangeRecord, indicating the documentation location.
  struct {
    uint32_t Offset;
    uint32_t Line;
    uint32_t Column;
    struct {
      uint32_t Offset;
      uint32_t LineOffset;
      uint32_t Length;
      uint32_t FileID;     // the offset to TEXT_DATA, indicating the file path
    } Directive;           // ExternalSourceLocs::LocationDirective
  } RawLoc[3];             // ExternalSourceLocs::RawLoc, Loc/StartLoc/EndLoc
};
```
* [Serializing BASIC_DECL_LOCS](https://github.com/apple/swift/blob/c2ca810126074406f03dc29a44f4ad4b12f04c79/lib/Serialization/SerializeDoc.cpp#L734-L750)
* [Parsing BASIC_DECL_LOCS](https://github.com/apple/swift/blob/c2ca810126074406f03dc29a44f4ad4b12f04c79/lib/Serialization/ModuleFile.cpp#L1199-L1222)

##### DECL_USRS
`DECL_USRS` is a serialized  `llvm::OnDiskIterableChainedHashTable`, where the key is a USR, and the value is the index of a location record in `BASIC_DECL_LOCS`. Virtually, the deserialized `DECL_USRS` looks like below.
```
s:10FooLibrary0A8ProtocolPA2A0A6StructVRszrlE3fooSSvpZ -> 4
s:10FooLibrary0A6StructV -> 2
s:10FooLibrary0A8ProtocolPA2A0A6StructVRszrlE3fooSSvgZ (Foo.swift:10:33) -> 3
s:10FooLibrary0A8ProtocolP -> 1
s:10FooLibrary3BarC -> 0
s:e:s:10FooLibrary0A8ProtocolPA2A0A6StructVRszrlE3fooSSvpZ -> 5
```
* [Serializing DECL_USRS](https://github.com/apple/swift/blob/c2ca810126074406f03dc29a44f4ad4b12f04c79/lib/Serialization/SerializeDoc.cpp#L550-L562)
* [Parsing DECL_USRS](https://github.com/apple/swift/blob/c2ca810126074406f03dc29a44f4ad4b12f04c79/lib/Serialization/ModuleFileSharedCore.cpp#L1157-L1167)

##### TEXT_DATA
`TEXT_DATA` is a list of `\0` terminated strings, which are the actual source file paths. As mentioned before, theyâ€™re [always absolute paths](https://github.com/apple/swift/blob/c2ca810126074406f03dc29a44f4ad4b12f04c79/lib/Serialization/SerializeDoc.cpp#L760-L762).

##### DOC_RANGES
A list of fixed-size item to represent the the location of documentation. The layout of one items is
```c
uint32_t nums;          // The number (N) of DocRangeRecord followed by this
struct {
  struct {
    ...                 // 7 uint32_t fields, same layout as the RawLoc in DeclLocRecord
  } RawLoc;
  uint32_t Unknown;     // Unknown what is this used for
} DocRangeRecord[N];    // N DocRangeRecord
```
* [Parsing DOC_RANGES](https://github.com/apple/swift/blob/c2ca810126074406f03dc29a44f4ad4b12f04c79/lib/Serialization/ModuleFile.cpp#L1206-L1217)
